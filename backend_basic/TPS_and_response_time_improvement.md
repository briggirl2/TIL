# 서버 성능 개선 기초

## 수직확장과 수평확장

|  | 수직확장(scale-up) | 수평확장(scale-out) |
| --- | --- | --- |
| 의미 | CPU, 메모리 등 자원 증가 | 서버 수 증가 |
| 특징 | 클라우드 환경에서 비교적 쉽게 수정 가능, 비용이 많이 드는 편 | DB나 외부 API에 문제 발생하지 않는 범위에서 해야함 |

---

## DB 커넥션 풀

- 서버와 DB 사이의 네트워크 연결하고 종료하는 시간을 줄이기 위해서
- DB에 연결된 커넥션을 미리 생성해서 보관
- 애플리케이션은 커넥션을 사용하고 반납하면서 재사용 가능
- 서버 개발에 필수적
- ex) Spring boot HikariCP

## 커넥션 풀 크기

- 최소 크기 / 최대 크기 설정 가능
- DB 서버가 포화에 이르지 않도록 해야함.
- 서버 수평확장도 결국 커넥션 풀 크기를 늘리는 것과 동일하다.
- 트래픽이 급증하는 패턴의 경우? 최소 크기를 크게 잡아둔다. (점진적일 때는 그럴필요없지만.)

커넥션 대기시간

- 풀에 사용할 수 있는 커넥션이 없을 때 커넥션을 얻기 위해 기다릴 수 있느 최대 시간
- 대기 시간에 커넥션을 얻지 못하면 DB 연결 실패 에러 발생
- 대기시간을 짧게 설정하면 서버 부하를 일정 수준으로 유지 가능 (길게 할 경우, 새로운 요청으로 서버 부하 증가)

## 커넥션 최대 유휴 시간, 유효성 검사, 최대 유지 시간

- MySQL 같은 DB는 클라이어느와 일정 시간 동안 상호작용 없으면 자동으로 연결 끊는 기능이 있음 → 이미 DB 연결이 끊긴 커넥션을 사용하면 에러 발생 → 이 에러를 방지하기 위한 방법들
- **최대 유휴 시간**: 사용되지 않는 커넥션을 풀에 유지할 수 있는 최대 시간
    - DB에 설정된 비활성화 유지 시간보다 짧게 설정 권장
- **유효성 검사**: 커넥션이 정상적을 사용할 수 있는 상태인지 여부 확인하는 절차
    - 커넥션 풀의 구현 방식에 따라 커넥션 풀을 가져올 때 또는 주기적으로 검사
    - 일부는 실제로 간단한 쿼리를 실행하기도 한다.
- **최대 유지 시간**: 커넥션이 생성된 시점부터 유지되는 시간
- 최대 유휴 시간, 최대 유지 시간은 무한대로 설정하지 말고 DB 설정에 알맞게 값을 지정해야한다.

---

## 캐시

- 적중률 (hit rate)
- 삭제 규칙
    - LRU
    - LFU
    - FIFO
- 로컬 캐시 특징 (리모트 캐시 - redis는 반대)
    - 빠름, 구조 단순
    - 서버 재시작에 영향
    - 메모리에 제약
    - ex) Caffeine (java)
- 캐시 사전 적재
    - 순간적으로 급증하는 패턴에 유용
    - ex) G앱은 매달 1일 모든 고객에게 이달의 요금 정보를 보여주고 푸시 알림을 보낸다. 푸시 알림을 통해서 고객은 앱으로 들어와 요금 정보를 확인한다.
- 캐시 무효화
    - 원본 데이터의 변화가 잦고 민감한 경우에 고려 필수

---

## GC(Garbage Collector)

- 사용이 끝난 객체를 힙메모리에서 바로 삭제하지 않고 정해진 규칙에 따라 사용하지 않는 메모리를 찾아서 반환
    - ex) 힙메모리 사용량이 일정 비율 초과할 때 또는 일정 주기로 자동 실행
- Stop-The-World : GC 실행되는 동안 애플리케이션이 일시 중단되는 현상
- 메모리를 많이 사용하고 생성된 객체가 많을수록 사용하지 않는 객체를 찾는 데 시간이 오래 걸린다.
- **혹시 문제가 생길 경우 heap dump 분석해서 메모리에서 높은 비중을 차지하는 객체를 찾자.**

## GC 시간 개선 방법

- 메모리 사용을 줄인다. 최대 힙크기를 줄이면 탐색할 크기도 줄어든다.
- 한 번에 대량으로 객체를 생성하는 것을 주의해야한다.
- 파일 다운로드 같은 기능 구현에는 스트림을 활용한다.

---

## 응답데이터 압축

- 전송시간
    - 네트워크 속도 → 서버 제어 밖의 영역
    - 전송 데이터 크기 → 압축 가능
- nginx 같은 웹 서버는 압축 기능 제공
    - ex) Accept-Encoding (전송시 알고리즘 지정)/ Content-Encoding(응답헤더에 포함)
- 텍스트의 경우 압축률이 높다.
- 응답데이터의 크기는 곧 비용으로 연결된다.

---

## 정적 자원과 브라우저 캐시

- 서버에 요청을 보내지 않고 로컬에 보관한 데이터 사용
- 로컬에서 데이터 불러오기때문에 빠름
- ex) cache-control

## 정적 자원과 CDN

- CDN(Content Delivery Network)
- 지역별 에지 서버에서 데이터 가져오기 때문에 서버 직접 연결보다 빠름
- 용량이 큰 파일 때문에 네트워크 트래픽이 급증하는 것을 방지하기 위해 웹서버 크기 제한 설정 추가 가능

---

## 대기 처리

- 최대 트래픽에 맞게 DB 성능을 올릴 경우, 다시 줄이기 쉽지 않다.
- 시스템 처리량을 무작정 늘리기 보다 수용할 수 있는 수준의 트래픽만 받아들이고 나머지는 대기 처리하는 방식
- 대기 제어 기능은 여러 솔루션 이미 존재.

---

**TODO**

- 로드밸런서 트래픽 분배 방식
    - 정적 - 라운드로빈, IP 해시 방식
    - 동적
- 대기 제어 기능 솔루션
- cache control test
- heap dump 분석