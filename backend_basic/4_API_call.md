# 4. 외부 연동이 문제일 때 살펴봐야 할 것들

## Timeout

- 외부 연동에서 가장 중요한 설정 중 하나
- 응답시간과 연관
- 타임아웃의 종류
    - connection timeout
    - read timeout
    - socket timeout : 소켓을 통한 I/O 작업에 대한 타임 제한(라이브러리별 의미 주의!)
    - call timeout : connection + write + read

## Retry

- 네트워크 통신 과정에서 간헐적으로 연결에 실패하거나 일시적으로 응답이 느려지는 경우 등의 외부 연동에 실패했을 때 처리 방법 중 하나
- 재시도 가능 조건
    - 단순 조회 기능
    - 연결 타임아웃
    - 멱등성(idempotent)을 가진 변경 기능
- 재시도 시 결정 요소
    - 재시도 횟수
    - 재시도 간격
- 재시도 폭풍(retry storm) 안티패턴
    - 재시도를 통해 성공 가능성을 높일 수 있지만 반대로 연동 서비스에 더 큰 부하를 줄 수 있다.

## 동시 요청 제한

- 연동 서비스에 임계치 이상의 요청을 보내면서 발생하는 성능 저하 문제를 완화하는 방법으로, 연동 서비스에 요청을 일정 수준 이상으로 보내지 않는 것이다.
- 연동 서비스에 요청을 보내지 않은 요청은 곧바로 에러를 응답한다. 503(Service Unavailable) HTTP status code를 사용해서 과부하 상황임을 클라인트에 알려 알맞은 오류 메시지를 출력할 수 있다.
- **Bulkhead** pattern
    - 각 구성 요소를 결리함으로써 한 구성 요소의 장애가 다른 구성 요소에 영향을 주지 않도록하는 설계 패턴

## Circuit Breaker

- 연동 서비스가 장애 상황일 때는 연동 대신 바로 에러를 응답하고ㄹ, 정상화되었을 때 연동을 재개하면 연동 서비스의 장애가 주는 영향(응답 시간 증가, 처리량 감소)을 줄일 수 있다.
- **서킷 브레이커**가 과도한 오류가 발생하면 연동을 중지시키고 바로 에러를 응답한다. ⇒ fail fast
- 서킷 브레이커의 세가지 상태
    - closed : 초기 상태 / 정상 상태
    - open : 실패가 임계치를 초과한 경우
    - half-open
- 임계치 조건 예시
    - 시간 기준 오류 발생 비율: ex) 10초 동안 오류 비율이 50% 초과
    - 개수 기준 오류 발생 비율: ex) 100개 요청 중 오류 비율이 50% 초과

## 외부 연동과 DB 연동

- 외부 연동에 실패했을 때 트랜잭션 롤백
    - DB에는 반영 안됨.
    - 하지만 읽기 타임아웃이 발생해 외부 서비스는 실제로 성공적으로 처리했을 가능성 있음.
        1. 일정 주기로 두 시스템의 데이터가 일치하는지 확안 하고 보정
        2. 성공 확인 API를 호출하는 방식 (연동서비스가 성공 확인 API를 제공할때만 가능)
- 외부 연동은 성공했는데 DB 연동에 실패해서 트랜잭션 롤백
    - 취소 API를 호출해서 외부 연동을 이전 상태로 되돌리는 것이 필요.
    - 취소 API가 없다면 일정 주기로 데이터가 맞는지 비교하는 프로세스 필요.
- 외부 연동이 느려질 때 DB 커넥션 풀 문제
    - DB 연동과 무관하게 외부 연동을 실행할 수 있다면, DB 커넥션 전이나 후에 외부 연동을 시도하는 방안 고려해볼 수 있다.
    - 단 이 방식은 외부 연동이 트랜잭션 밖에서 실행되기 때문에 외부 연동이 실패한 경우 외부 연동에 대한 롤백 후처리 따로 필요.
    - 후처리 방법으로는 트랜잭션으로 반영된 데이터를 보상 트랜잭션을 사용하는 방법 또는 기능 특성에 따라 데이터를 후보정하는 방법 등이 있다.

## HTTP 커넥션 풀

- 설정 요소
    - HTTP 커넥션 풀의 크기
    - 풀에서 HTTP 커넥션을 가져올 때까지 대기하는 시간
    - HTTP 커넥션을 유지할 시간(keep-alive)

## 연동 서비스의 이중화

- 서비스가 대량 트래픽을 처리할 만큼 성장하면 고려 필요
- 이중화 여부 결정시 고려 요소
    - 해당 기능이 서비스의 핵심인지 여부
    - 이중화 비용이 감당 가능한 수준인지